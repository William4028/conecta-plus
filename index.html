<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConectaPlus</title>
  <meta name="description" content="ConectaPlus — login rápido e perfil (Brasil) com Firebase Auth + Firestore." />
  <style>
    :root{
      --bg1:#13060a; --bg2:#2b0d14;
      --card: rgba(40, 40, 50, .45);
      --border: rgba(255,255,255,.10);
      --text:#eaeaf0; --muted:rgba(234,234,240,.75);
      --pink:#ff3b6b;
    }
    body{
      margin:0; min-height:100vh; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 15%, #3a0f1e 0%, transparent 55%),
                  linear-gradient(135deg, var(--bg2), var(--bg1));
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:min(560px, 100%);}
    .brand{font-size:48px; font-weight:800; letter-spacing:-1px; margin:0 0 14px;}
    .brand .p{color:var(--pink);}
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 80px rgba(0,0,0,.40);
    }
    .hint{color:var(--muted); margin:10px 0 14px; line-height:1.35}
    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      background: var(--pink);
      color:#fff;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .row{display:flex; gap:12px; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border); background: rgba(0,0,0,.25);
      font-weight:700;
    }
    .avatar{
      width:56px; height:56px; border-radius:16px; object-fit:cover;
      border:1px solid var(--border);
    }
    .sp{height:10px}
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    .label{font-size:13px; color:var(--muted); margin:10px 0 6px}
    .mini{font-size:13px; color:var(--muted); line-height:1.35}
    .danger{color:#ff9aa8}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
    .linkbtn{
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .ok{color:#9effb6}
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:12px;
      word-break:break-all;
      color:rgba(234,234,240,.9);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="brand">Conecta<span class="p">Plus</span></h1>

    <!-- TELA LOGIN -->
    <div id="screenLogin" class="card">
      <div class="hint">
        Login rápido pra liberar seu perfil. Depois a gente coloca <b>Ficar / Namorar / Ver o que rola.</b>
      </div>

      <button id="btnGoogle" class="btn">Entrar com Google</button>
      <div class="sp"></div>

      <div id="loginInfo" style="display:none">
        <div class="row">
          <span class="pill">Logado ✅</span>
          <button id="btnSair" class="linkbtn">Sair</button>
        </div>
        <div class="sp"></div>
        <div class="row">
          <img id="userPhoto" class="avatar" alt="foto"/>
          <div>
            <div style="font-weight:900; font-size:18px" id="userName">—</div>
            <div class="mini" id="userEmail">—</div>
          </div>
        </div>

        <div class="sp"></div>
        <button id="btnContinuar" class="btn">Continuar</button>

        <div class="sp"></div>
        <div class="mini">Próximo passo: preencher Perfil + salvar no Firestore.</div>
      </div>

      <div class="sp"></div>
      <div id="errBox" class="mini danger"></div>

      <div class="sp"></div>
      <div class="mini">
        Dica: se der erro de domínio, no Firebase vá em
        <b>Authentication → Configurações → Domínios autorizados</b> e adicione:
        <div class="sp"></div>
        <div class="code">william4028.github.io</div>
      </div>
    </div>

    <!-- TELA PERFIL -->
    <div id="screenPerfil" class="card" style="display:none">
      <div class="topbar">
        <div class="pill">Perfil</div>
        <button id="btnVoltar" class="linkbtn">Voltar</button>
      </div>

      <div class="label">Nome</div>
      <input id="inpNome" class="input" placeholder="Seu nome" />

      <div class="label">Objetivo</div>
      <select id="selObjetivo" class="input">
        <option value="Encontro certo">Encontro certo</option>
        <option value="Ficar">Ficar</option>
        <option value="Namorar">Namorar</option>
        <option value="Ver o que rola">Ver o que rola</option>
        <option value="Tinder (1 de cada vez)">Tinder (1 de cada vez)</option>
      </select>

      <div class="label">Cidade (Brasil)</div>
      <input id="inpCidade" class="input" placeholder="Ex: Juiz de Fora - MG" />

      <div class="sp"></div>
      <button id="btnSalvar" class="btn">Salvar no Firestore</button>

      <div class="sp"></div>
      <div id="perfilMsg" class="mini"></div>

      <div class="sp"></div>
      <div class="mini">
        (Segurança) Regras recomendadas do Firestore:
        <div class="sp"></div>
        <div class="code">match /users/{uid} { allow read, write: if request.auth != null &amp;&amp; request.auth.uid == uid; }</div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase (SDK modular via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ✅ Seu firebaseConfig (pego em: Firebase Console → Configurações do projeto → Seus apps → Web → "Configuração do SDK")
    const firebaseConfig = {
      apiKey: "AIzaSyADFaVHqZWtFO-etJsP4JucbDQBbseIhBc",
      authDomain: "conectaplus-b3174.firebaseapp.com",
      projectId: "conectaplus-b3174",
      storageBucket: "conectaplus-b3174.firebasestorage.app",
      messagingSenderId: "304017868403",
      appId: "1:304017868403:web:7f1189c0e297d73ada8c06"
    };

    // ---------- UI helpers ----------
    const $ = (id) => document.getElementById(id);
    const screenLogin = $("screenLogin");
    const screenPerfil = $("screenPerfil");

    const btnGoogle = $("btnGoogle");
    const btnSair = $("btnSair");
    const btnContinuar = $("btnContinuar");
    const btnVoltar = $("btnVoltar");
    const btnSalvar = $("btnSalvar");

    const loginInfo = $("loginInfo");
    const errBox = $("errBox");

    const userPhoto = $("userPhoto");
    const userName = $("userName");
    const userEmail = $("userEmail");

    const inpNome = $("inpNome");
    const selObjetivo = $("selObjetivo");
    const inpCidade = $("inpCidade");
    const perfilMsg = $("perfilMsg");

    function showLogin(){
      screenLogin.style.display = "block";
      screenPerfil.style.display = "none";
      perfilMsg.textContent = "";
    }

    function showPerfil(){
      screenLogin.style.display = "none";
      screenPerfil.style.display = "block";
      perfilMsg.textContent = "";
    }

    function setError(msg){
      errBox.textContent = msg || "";
    }

    function setBusy(isBusy){
      btnGoogle.disabled = isBusy;
      btnSair.disabled = isBusy;
      btnContinuar.disabled = isBusy;
      btnVoltar.disabled = isBusy;
      btnSalvar.disabled = isBusy;
    }

    // ---------- Init ----------
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (e) {
      setError("⚠️ Erro ao iniciar Firebase. Confira o firebaseConfig.");
      console.error(e);
    }

    const provider = new GoogleAuthProvider();

    // Persistência (mantém login)
    if (auth) {
      setPersistence(auth, browserLocalPersistence).catch(console.error);
    }

    // Se o login usar REDIRECT, aqui pega o resultado quando voltar do Google
    async function handleRedirect(){
      if(!auth) return;
      try {
        await getRedirectResult(auth);
      } catch (e) {
        // Se usuário cancela, não precisa assustar
        const msg = e?.message || String(e);
        if (!msg.toLowerCase().includes("cancelled") && !msg.toLowerCase().includes("canceled")) {
          console.error(e);
          setError("Erro no login (redirect): " + msg);
        }
      }
    }
    handleRedirect();

    // ---------- Auth ----------
    async function loginGoogle(){
      setError("");
      setBusy(true);
      try {
        // Em celular, popup às vezes é bloqueado; redirect é mais confiável.
        // Tenta popup primeiro (mais rápido), se falhar cai pro redirect.
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          const msg = (e?.message || "").toLowerCase();
          const popupProblema =
            msg.includes("popup") || msg.includes("blocked") || msg.includes("cancelled") || msg.includes("canceled");
          if (popupProblema) {
            await signInWithRedirect(auth, provider);
          } else {
            throw e;
          }
        }
      } catch (e) {
        console.error(e);
        setError("Erro no login: " + (e?.message || e));
      } finally {
        setBusy(false);
      }
    }

    btnGoogle.addEventListener("click", loginGoogle);

    btnSair.addEventListener("click", async () => {
      setError("");
      setBusy(true);
      try {
        await signOut(auth);
        showLogin();
      } finally {
        setBusy(false);
      }
    });

    btnContinuar.addEventListener("click", async () => {
      // Abre a tela de perfil e tenta carregar dados existentes do usuário
      const u = auth.currentUser;
      if(!u) return;

      showPerfil();

      // Prefill (se já existe no Firestore, carrega)
      perfilMsg.textContent = "Carregando seu perfil…";
      perfilMsg.className = "mini";
      setBusy(true);

      try {
        const ref = doc(db, "users", u.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          inpNome.value = data?.nome || (u.displayName || "");
          selObjetivo.value = data?.objetivo || "Encontro certo";
          inpCidade.value = data?.cidade || "";
          perfilMsg.textContent = "Perfil carregado ✅";
          perfilMsg.className = "mini ok";
        } else {
          inpNome.value = u.displayName || "";
          selObjetivo.value = "Encontro certo";
          inpCidade.value = "";
          perfilMsg.textContent = "Preencha seu perfil e salve ✅";
          perfilMsg.className = "mini";
        }
      } catch (e) {
        console.error(e);
        perfilMsg.textContent = "Não consegui carregar. Você pode salvar mesmo assim.";
        perfilMsg.className = "mini danger";
      } finally {
        setBusy(false);
      }
    });

    btnVoltar.addEventListener("click", () => {
      showLogin();
    });

    btnSalvar.addEventListener("click", async () => {
      perfilMsg.textContent = "";
      const u = auth.currentUser;
      if(!u){
        perfilMsg.textContent = "Você precisa estar logado.";
        perfilMsg.className = "mini danger";
        return;
      }

      const nome = (inpNome.value || "").trim();
      const objetivo = selObjetivo.value;
      const cidade = (inpCidade.value || "").trim();

      if(!nome || !cidade){
        perfilMsg.textContent = "Preencha pelo menos Nome e Cidade.";
        perfilMsg.className = "mini danger";
        return;
      }

      setBusy(true);
      perfilMsg.textContent = "Salvando no Firestore…";
      perfilMsg.className = "mini";

      try {
        const ref = doc(db, "users", u.uid);
        const snap = await getDoc(ref);
        const existing = snap.exists() ? (snap.data() || {}) : null;

        await setDoc(ref, {
          uid: u.uid,
          nome,
          objetivo,
          cidade,
          email: u.email || null,
          foto: u.photoURL || null,
          createdAt: existing?.createdAt ?? serverTimestamp(), // não troca se já existir
          updatedAt: serverTimestamp(),
        }, { merge: true });

        perfilMsg.textContent = "Salvo ✅ Agora olha no Firestore: users → " + u.uid;
        perfilMsg.className = "mini ok";
      } catch (e) {
        console.error(e);
        perfilMsg.textContent = "Erro ao salvar: " + (e?.message || e);
        perfilMsg.className = "mini danger";
      } finally {
        setBusy(false);
      }
    });

    onAuthStateChanged(auth, (u) => {
      if (u) {
        loginInfo.style.display = "block";
        btnGoogle.style.display = "none";
        userPhoto.src = u.photoURL || "";
        userPhoto.style.display = u.photoURL ? "block" : "none";
        userName.textContent = u.displayName || "Usuário";
        userEmail.textContent = u.email || "";
        btnContinuar.disabled = false;
        setError("");
      } else {
        loginInfo.style.display = "none";
        btnGoogle.style.display = "block";
        btnContinuar.disabled = true;
        showLogin();
      }
    });
  </script>
</body>
</html>
